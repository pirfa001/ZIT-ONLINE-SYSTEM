{% extends 'base.html' %}

{% block title %}Course Moderation - Admin Dashboard{% endblock %}

{% block content %}
<div class="bg-gray-50 min-h-screen py-8">
  <div class="container mx-auto px-6">
    <!-- Header -->
    <div class="mb-8">
      <h1 class="text-3xl font-extrabold text-gray-900">Course Moderation</h1>
      <p class="text-gray-600 mt-2">Review and approve/reject instructor-created courses</p>
    </div>

    <!-- Tab Navigation -->
    <div class="flex space-x-4 mb-8 border-b border-gray-200">
      <button class="tab-btn px-6 py-3 font-medium text-gray-700 border-b-2 border-blue-500 text-blue-600" data-tab="pending">
        Pending ({{ pending_courses | length }})
      </button>
      <button class="tab-btn px-6 py-3 font-medium text-gray-700 border-b-2 border-transparent hover:text-gray-900" data-tab="approved">
        Approved ({{ approved_courses | length }})
      </button>
      <button class="tab-btn px-6 py-3 font-medium text-gray-700 border-b-2 border-transparent hover:text-gray-900" data-tab="rejected">
        Rejected ({{ rejected_courses | length }})
      </button>
    </div>

    <!-- PENDING COURSES -->
    <div id="pending" class="tab-content">
      {% if pending_courses %}
      <div class="space-y-6">
        {% for course in pending_courses %}
        <div class="bg-white p-6 rounded-lg shadow-sm border-l-4 border-yellow-400">
          <div class="grid grid-cols-3 gap-4 items-start">
            <!-- Course Info -->
            <div class="col-span-2">
              <h3 class="text-xl font-bold text-gray-900 mb-2">{{ course.title }}</h3>
              <p class="text-gray-600 mb-3">{{ course.description | truncate(200) }}</p>
              <div class="flex space-x-4 text-sm text-gray-500">
                <span>üìö {{ course.modules | length }} modules</span>
                <span>üë®‚Äçüè´ {{ course.instructor.full_name }}</span>
                <span>üí∞ {% if course.price == 0 %}Free{% else %}NGN {{ course.price | float | round(2) }}{% endif %}</span>
                <span>üìÖ {{ course.created_at.strftime('%Y-%m-%d') }}</span>
              </div>
            </div>

            <!-- Action Buttons -->
            <div class="flex flex-col space-y-2">
              <form method="POST" action="{{ url_for('admin_approve_course', course_id=course.id) }}" class="w-full">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                <button type="submit" class="w-full bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700 font-medium transition">
                  ‚úì Approve
                </button>
              </form>
              <button onclick="openRejectModal({{ course.id }}, '{{ course.title }}')" class="w-full bg-red-600 text-white px-4 py-2 rounded hover:bg-red-700 font-medium transition">
                ‚úï Reject
              </button>
            </div>
          </div>
        </div>
        {% endfor %}
      </div>
      {% else %}
      <div class="bg-white p-8 rounded-lg text-center text-gray-500">
        No pending courses
      </div>
      {% endif %}
    </div>

    <!-- APPROVED COURSES -->
    <div id="approved" class="tab-content hidden">
      {% if approved_courses %}
      <div class="bg-white rounded-lg shadow-sm overflow-hidden">
        <table class="w-full">
          <thead class="bg-green-50 border-b border-gray-200">
            <tr>
              <th class="text-left py-3 px-4 font-semibold text-gray-700">Title</th>
              <th class="text-left py-3 px-4 font-semibold text-gray-700">Instructor</th>
              <th class="text-left py-3 px-4 font-semibold text-gray-700">Approved</th>
            </tr>
          </thead>
          <tbody class="divide-y divide-gray-200">
            {% for course in approved_courses %}
            <tr class="hover:bg-gray-50">
              <td class="py-3 px-4 font-medium text-gray-900">{{ course.title }}</td>
              <td class="py-3 px-4 text-gray-600">{{ course.instructor.full_name }}</td>
              <td class="py-3 px-4 text-sm text-gray-500">{{ course.created_at.strftime('%Y-%m-%d') }}</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      {% else %}
      <div class="bg-white p-8 rounded-lg text-center text-gray-500">
        No approved courses
      </div>
      {% endif %}
    </div>

    <!-- REJECTED COURSES -->
    <div id="rejected" class="tab-content hidden">
      {% if rejected_courses %}
      <div class="space-y-4">
        {% for course in rejected_courses %}
        <div class="bg-white p-4 rounded-lg shadow-sm border-l-4 border-red-400">
          <h4 class="font-bold text-gray-900">{{ course.title }}</h4>
          <p class="text-sm text-gray-600 mt-1"><strong>Reason:</strong> {{ course.rejection_reason }}</p>
          <p class="text-xs text-gray-500 mt-2">By {{ course.instructor.full_name }}</p>
        </div>
        {% endfor %}
      </div>
      {% else %}
      <div class="bg-white p-8 rounded-lg text-center text-gray-500">
        No rejected courses
      </div>
      {% endif %}
    </div>
  </div>
</div>

<!-- Rejection Modal -->
<div id="rejectModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
  <div class="bg-white rounded-lg p-8 max-w-md w-full mx-4">
    <h3 class="text-xl font-bold text-gray-900 mb-4">Reject Course</h3>
    <p id="courseTitle" class="text-gray-600 mb-4"></p>
    <form id="rejectForm" method="POST" class="space-y-4">
      <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-2">Reason for Rejection</label>
        <textarea name="reason" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-red-500" rows="4"></textarea>
      </div>
      <div class="flex space-x-3">
        <button type="submit" class="flex-1 bg-red-600 text-white px-4 py-2 rounded hover:bg-red-700 font-medium transition">
          Reject
        </button>
        <button type="button" onclick="closeRejectModal()" class="flex-1 bg-gray-300 text-gray-800 px-4 py-2 rounded hover:bg-gray-400 font-medium transition">
          Cancel
        </button>
      </div>
    </form>
  </div>
</div>

<script>
// Tab switching
document.querySelectorAll('.tab-btn').forEach(btn => {
  btn.addEventListener('click', function() {
    const tabName = this.dataset.tab;
    document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden'));
    document.querySelectorAll('.tab-btn').forEach(el => {
      el.classList.remove('border-blue-500', 'text-blue-600');
      el.classList.add('border-transparent');
    });
    document.getElementById(tabName).classList.remove('hidden');
    this.classList.add('border-blue-500', 'text-blue-600');
  });
});

// Modal functions
function openRejectModal(courseId, courseTitle) {
  document.getElementById('courseTitle').textContent = `Are you sure you want to reject "${courseTitle}"?`;
  document.getElementById('rejectForm').action = `/admin/courses/${courseId}/reject`;
  document.getElementById('rejectModal').classList.remove('hidden');
}

function closeRejectModal() {
  document.getElementById('rejectModal').classList.add('hidden');
}

// Close modal on outside click
document.getElementById('rejectModal').addEventListener('click', function(e) {
  if (e.target === this) closeRejectModal();
});
</script>
{% endblock %}
