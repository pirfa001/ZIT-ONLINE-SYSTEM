{% extends 'base.html' %}

{% block title %}Quiz - ZIT Learn Online{% endblock %}

{% block content %}
<div class="max-w-3xl mx-auto bg-white p-8 rounded-lg shadow-lg">
  <h2 class="text-2xl font-bold mb-4">{{ quiz.title }}</h2>

  <div id="quizContainer" class="space-y-6">
    {% for q in questions %}
    <div class="p-4 border rounded-lg" data-question-id="{{ q.id }}">
      <p class="font-semibold">Q{{ loop.index }}. {{ q.text }}</p>
      <div class="mt-3 space-y-2">
        {% for c in q.choices %}
        <div>
          <label class="inline-flex items-center">
            <input type="radio" name="q-{{ q.id }}" value="{{ c.id }}" class="mr-2 choice-radio">
            <span>{{ c.text }}</span>
          </label>
        </div>
        {% endfor %}
      </div>

      <div class="mt-3">
        <button data-qid="{{ q.id }}" class="submit-answer bg-blue-600 text-white px-3 py-1 rounded">Submit Answer</button>
        <div class="mt-2 feedback text-sm" id="feedback-{{ q.id }}"></div>
      </div>
    </div>
    {% endfor %}
  </div>
  <div class="mt-6">
    <a href="{{ url_for('course_detail', course_id=quiz.course_id) }}" class="text-blue-600 hover:underline">Back to Course</a>
  </div>
</div>

<script>
document.addEventListener('click', async (e) => {
  if (!e.target.matches('.submit-answer')) return;
  const btn = e.target;
  const qid = btn.dataset.qid;
  const container = document.querySelector(`[data-question-id='${qid}']`);
  const selected = container.querySelector(`input[name='q-${qid}']:checked`);
  const fb = document.getElementById(`feedback-${qid}`);
  fb.textContent = '';
  if (!selected) { fb.textContent = 'Please select an answer.'; return; }

  try {
    // FIXED: Use numeric placeholder 0 instead of string 'QUESTION_ID_PLACEHOLDER'
    const urlTemplate = `{{ url_for('submit_answer', quiz_id=quiz.id, question_id=0, _external=false) }}`;
    const url = urlTemplate.replace('/0', `/${qid}`);
    const resp = await fetch(url, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ choice_id: selected.value })
    });
    const data = await resp.json();
    if (data.correct) {
      fb.innerHTML = `<span class='text-green-700 font-semibold'>Correct</span>${data.explanation ? ': ' + data.explanation : ''}`;
    } else {
      fb.innerHTML = `<span class='text-red-700 font-semibold'>Incorrect</span>${data.explanation ? ': ' + data.explanation : ''}`;
    }
  } catch (err) {
    fb.textContent = 'Error submitting answer.';
  }
});
</script>

{% endblock %}